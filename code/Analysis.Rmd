---
title: "Electricity Prices & Renewable Generation"
author: "Ebba Mark"
date: '`r Sys.Date()`'
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}

library(tidyverse)
library(here)
library(gets)
library(readxl)
library(janitor)
library(conflicted)
library(patchwork)
library(fastDummies)
library(modelsummary)
library(gridExtra)
library(countrycode)
library(tidyquant)
library(kableExtra)
conflict_prefer_all("gets", quiet = TRUE)
conflicts_prefer(dplyr::filter)
knitr::opts_chunk$set(echo = TRUE)

source(here("code/rintamaki_replication/models/helper_code.R"))

```

# Overview {.tabset}

**Motivation:** Recall our motivation originally stemming from an interest in the "relative" volatility of fossil fuel versus renewable prices. After repeated discussion regarding the comparability of the two types of energy sources and scoping of the data available we pivoted to questions more directly related to "explaining"/investigating the recent spike in electricity prices (both in level and volatility) following a surge in natural gas prices and the Russian invasion of Ukraine and how it might have been mediated (or not) by increased renewable energy generation.


**RQs:** Though still to be workshopped, potential guiding questions along these lines (most follow from our past conversations):               
1. To what extent, if any, does increased reliance on renewable sources of electricity insulate consumers or industry from the effects of spikes in electricity price inputs (ie. natural gas spike post-Ukraine)?               
2. What are the costs (to electricity consumers - industrial and/or household) of recent increased price volatility and to what extent is greater renewable energy as a share of generating capacity a mediating or aggravating force?              
3. Setting the price is an economic question - how efficiently does the market translate the true cost into price signals (ie. shifting share to lower cost renewables not yet filtering into price signals due to marginal price-setting in the market)?                  
4. What is the potential efficiency gain of switching to renewables even if it is not yet translated into prices?                  
5. Exogenous: use the connection of large wind or solar connections to the grid as plausible exogenous variation. See if there have been changes in capacity and whether they had any detectable effect on prices, all else equal.                  



**Data:** The below documents the data currently pulled to attempt a preliminary mean model of hourly wholesale electricity prices in Germany:
* *Wholesale Electricity Prices* (Hourly - EMBER)               
* *Electricity Demand/Load* (Hourly - ENTSOE)               
* *Electricity Generated by Energy Source* (Hourly - ENTSOE)               
* *Various Commodity Price Indices* (Monthly - IMF)               
* *Total and Country-Specific Net imports* (Hourly - ENTSOE)               
* *Day-ahead Solar and Wind Forecasts* (Hourly - ENTSOE)               
* *Redispatching Costs* ("Hourly" - netztransparenz.de - they are reported at a particular hour but are contracted for "implementation" over a certain multi-hour period, I think...as mentioned, to be investigate more)               

Data that remains to be integrated:               
* *Auction Bid Data* (Data on electricity auction bids - this would likely 1. help us determine if renewables set the market price (if ever) and 2. the variability in generation costs of fossil fuel providers)               
* *Economic Activity* (GDP or VAT)               


**Data Issues:**
Several data issues cropped up in the process. I note the most glaring issues in **bold** throughout this notebook. Notably, the main issues are:                     
* the lower-frequency of certain candidate explanatory variables (ie. fuel and non-fuel commodity prices and redispatching costs)                              
* missing data on net imports from France and Denmark in specific years (data exists but is not complete)               
* how to aggregate the data on redispatching costs which are reported with hourly specificity but with different summarising metrics and "implementation horizons" (ie a load-balancing request made with a 4-hour implementation horizon). Fortunately, it does nto seem to be an issue of data availabilty but rather deeper thinking about what measure (and harmonisation across energy types) is most relevant for our ultimtate research question.                  


**Model Attempt:** Preliminary model attempt bringing this data together using gets under the "approaching a model..." tab.                      


**Additional thoughts:** Though, ultimately, it would be very ineresting to broaden to a multi-country scope (especially if this might allow for some comparative analysis on variable country-specific shares of renewable electricity generation), we decided to focus on Germany as a first case to see how we go. If/when we take the step to further countries, any data that I pull from ENTSO-E has an accompanying scraping script that could (reasonably) easily be repurposed to pull the identical data on other countries.                            


## **Start simple: Germany Only** {.tabset}
### **Data** {.tabset}

Using data from [EMBER](https://ember-energy.org/data/european-wholesale-electricity-price-data/) on European wholesale electricity prices (hourly - daily and monthly also exist). The hourly prices are the day-ahead wholesale prices in Germany.

```{r, echo = FALSE, fig.height = 8, fig.width = 12, warning = FALSE, cache = TRUE}

de_hourly_prices <- read.csv(here('data/raw/EMBER_europe_wholesale_data/all_countries.csv')) %>% 
  tibble %>% 
  clean_names %>% 
  mutate(across(contains("datetime"), ~ymd_hms(.x))) %>% 
  filter(country == "Germany")

de_hourly_prices %>% 
  ggplot(aes(x = datetime_utc, y = price_eur_m_whe)) +
  geom_line(color = "grey") +
  geom_ma(ma_fun = SMA, n = 731, color = "purple", linetype = "solid") +
  geom_ma(ma_fun = SMA, n = 8766, color = "red", linetype = "solid") +
  theme_minimal() + 
  labs(x = "Date", y = "Wholesale Electricity Price (Euro/MWh", title = "Hourly Wholesale Electricity Prices in Germany (January 2015- December 2024)")

```

#### **Electricity Demand/Load**

Total load per bidding zone per market time unit - in our case, total load, per country, per hour in MW.

[Source](https://transparency.entsoe.eu/content/static_content/Static%20content/knowledge%20base/data-views/load-domain/Data-view%20Total%20Load%20-%20Day%20Ahead%20-%20Actual.html)

The following is data from [ENTSO-E](https://www.entsoe.eu/data/power-stats/) on hourly electricity loads. 

Components: Actual total load (including losses without stored energy) = net generation – exports + imports – absorbed energy

```{r, echo = FALSE, fig.height = 8, fig.width = 12, warning = FALSE, cache = TRUE, message = FALSE}

### ENTSOE Data
entsoe_de <- readRDS(here("data/out/entsoe_load_data_consolidated.rds")) %>% 
  tibble %>% 
  # Filters old observations from 2006-07 for CS - Serbia and Montenegro - represented by "RS" and "ME", respectively
  filter(!(country_code %in% c("CS"))) %>% 
  # Denmark is inconsistently names - DK_W until 2010 and DK after 2010 - no observation for Denmark East exists therefore consolidation seems OK
  mutate(country_code = ifelse(country_code == "DK_W", "DK", country_code),
         # adds new column with country names
         country = countrycode(country_code, "iso2c", "country.name"),
         country = ifelse(is.na(country), paste0("?",country_code, "?"), country)) %>% 
  # restrict to country's for which we have hourly price data
  filter(country == "Germany") %>% 
  group_by(date_utc, country_code, country) %>% 
  summarise(load = max(load)) %>% 
  ungroup

entsoe_de %>% 
  filter(date_utc >= "2015-01-01" & date_utc < "2025-01-01") %>% 
  ggplot() + 
  geom_line(aes(x = date_utc, y = load), size = 0.05) 
  
```

#### **Generation by Resource**

Actual Generation per Production Type from [ENTSOE](https://transparency.entsoe.eu/content/static_content/Static%20content/knowledge%20base/data-views/generation/Data-view%20Actual%20Generation%20per%20Production%20Unit.html)
This value represents the actual aggregated net generation output in MW per market time unit (hour) and per production type.

**Note: There is 1 observation missing per year (either 0 or NA) on a late day in march at 2 am....a cleaning issue? Something silly?**         

```{r, echo = FALSE, fig.height = 8, fig.width = 12,  warning = FALSE, cache = TRUE}

de_generation <- readRDS(here('data/raw/ENTSOE/generation_per_prod_type_DE/de_generation_consolidated.rds')) %>% 
  mutate(country_code = "DE",
         country = "Germany") %>% 
  relocate(country, country_code) %>% 
  arrange(date_utc) %>% 
  # Investigate NAs...
  mutate(across(contains("mean"), ~ifelse(is.nan(.), NA, .))) %>% 
  rowwise() %>% 
  mutate(gen_biomass_mw = mean_biomass_actual_aggregated_mw,
         gen_storage_mw = mean_energy_storage_actual_aggregated_mw,
         gen_coal_mw = sum(mean_fossil_brown_coal_lignite_actual_aggregated_mw, mean_fossil_coal_derived_gas_actual_aggregated_mw, mean_fossil_hard_coal_actual_aggregated_mw, na.rm = TRUE),
         gen_gas_mw = mean_fossil_gas_actual_aggregated_mw,
         gen_oil_mw = sum(mean_fossil_oil_actual_aggregated_mw, mean_fossil_oil_shale_actual_aggregated_mw, na.rm = TRUE),
         gen_peat_mw = mean_fossil_peat_actual_aggregated_mw,
         gen_geoth_mw = mean_geothermal_actual_aggregated_mw,
         gen_hydro_mw = 
           sum(mean_hydro_pumped_storage_actual_aggregated_mw,mean_hydro_pumped_storage_actual_consumption_mw,
               mean_hydro_run_of_river_and_poundage_actual_aggregated_mw, 
               mean_hydro_water_reservoir_actual_aggregated_mw, mean_marine_actual_aggregated_mw, na.rm = TRUE),
         gen_nuclear_mw = mean_nuclear_actual_aggregated_mw,
         gen_other_mw = sum(mean_other_actual_aggregated_mw, mean_waste_actual_aggregated_mw, na.rm = TRUE),
         gen_oth_ren_mw = mean_other_renewable_actual_aggregated_mw,
         gen_solar_mw = mean_solar_actual_aggregated_mw,                          
         gen_wind_mw = sum(mean_wind_offshore_actual_aggregated_mw, mean_wind_onshore_actual_aggregated_mw, na.rm = TRUE)) %>% 
  ungroup

de_generation %>% 
  filter(date_utc >= "2015-01-01" & date_utc < "2025-01-01") %>% 
  select(date_utc, contains("gen")) %>% 
  pivot_longer(!date_utc) %>% 
  filter(!(name %in% c('gen_peat_mw', 'gen_storage_mw'))) %>% 
  ggplot(aes(x = date_utc, y = value, group = name)) +
  geom_line() +
  geom_ma(ma_fun = SMA, n = 4383, color = "purple") +
  geom_ma(ma_fun = SMA, n = 8766, color = "yellow") +
  facet_wrap(~name, scales = "free")

de_generation %>% 
  filter(date_utc >= "2015-01-01" & date_utc < "2025-01-01") %>% 
  mutate(ym = format(as.Date(date_utc), "%Y-%m")) %>% 
  group_by(ym) %>% 
  summarise(across(contains('gen'), ~mean(., na.rm = TRUE))) %>% 
  pivot_longer(!ym) %>% 
  mutate(ym = ym(ym)) %>% 
  filter(!(name %in% c('gen_peat_mw', 'gen_storage_mw'))) %>% 
  ggplot(aes(x = as.Date(ym), y = value, fill = name)) +
  geom_area() +
  labs(x = "Date", y = "Total Generation (MW)", title = "Electricity Generated (MW) by Source")

```

#### **Fuel and Commodity Prices**
IMF provides *monthly* commodity prices and price indices.          
Source: https://www.imf.org/en/Research/commodity-prices        

The commodity prices listed below are:        

**Note: These are MONTHLY values. I fill these values to hourly when merging the data later on.**

I include the following three commodity prices in the model selection for now (final plot in this section):              
* Natural Gas, Netherlands TTF Natural Gas Forward Day Ahead, US$ per Million Metric British Thermal Unit                
* Fuel & Non-Fuel Commodities: All Commodity Price Index, 2016 = 100, includes both Fuel and Non-Fuel Price Indices              
* Indust. Input Price: Industrial Inputs Price Index, 2016 = 100, includes Agricultural Raw Materials and Base Metals Price Indices       

**Note: We should probably rethink the non-natural gas prices (the latter two indices). The two latter indices are global indices and given the industrial structure of Germany we might want to consider a Producer Price Index for Germany specifically, assuming that exists? Additionally, as you can see in the graph, the latter two essentially trace each other/collinearity issues.**

```{r, echo = FALSE, fig.height = 8, fig.width = 12, warning = FALSE, cache = TRUE}

commodity_prices <- read_xls(here("data/raw/imf_primary_commodity_price_data_external-data.xls")) 
# Extract the description rows (2 to 4)
descriptions <- commodity_prices %>%
  slice(1:3) %>% 
  select(-1)

# Relevant commodity prices
rel_vars <- c(
  # GENERAL COMMODITY PRICES - MIGHT BE WORTH HAVING ONE FOR GERMANY EXPLICITLY
  "PALLFNF" = "Fuel & Non-Fuel Commodities", # All Commodity Price Index, 2016 = 100, includes both Fuel and Non-Fuel Price Indices
  "PINDU" = "Indust. Input Price", # Industrial Inputs Price Index, 2016 = 100, includes Agricultural Raw Materials and Base Metals Price Indices
  # FUELS
  "PNRG" = "Fuel (Energy - oil, ng, coal, propane)", # Fuel (Energy) Index, 2016 = 100, includes Crude oil (petroleum), Natural Gas, Coal Price and Propane Indices
  # - OIL
  "POILAPSP_USD" = "Oil - Avg Brent, West TX, Dubai (USD)", # Crude Oil (petroleum), Price index, 2016 = 100, simple average of three spot prices; Dated Brent, West Texas Intermediate, and the Dubai Fateh
  "POILAPSP" = "Oil - Avg Brent, West TX, Dubai", # Crude Oil (petroleum), Price index, 2016 = 100, simple average of three spot prices; Dated Brent, West Texas Intermediate, and the Dubai Fateh
  "POILBRE" = "Oil - Brent", # Crude Oil (petroleum),  Dated Brent, light blend 38 API, fob U.K., US$ per barrel
  "POILDUB" = "Oil - Dubai", # Crude Oil (petroleum), Dubai Fateh Fateh 32 API, US$ per barrel
  "POILWTI" = "Oil - West TX", # Crude Oil (petroleum), West Texas Intermediate 40 API, Midland Texas, US$ per barrel
  
  # - COAL
  "PCOAL" = "Coal", # Coal Price Index, 2016 = 100, includes Australian and South African Coal

  # - GAS
  "PNGAS" = "Nat. Gas (Euro, Jap, American)", # Natural Gas Price Index, 2016 = 100, includes European, Japanese, and American Natural Gas Price Indices
  "PNGASEU" = "Nat. Gas (NDL TTF)", # Natural Gas, Netherlands TTF Natural Gas Forward Day Ahead, US$ per Million Metric British Thermal Unit
  "PNGASJP" = "Nat. Gas (Indonesian LNG in Japan)", # Natural Gas, Indonesian Liquefied Natural Gas in Japan, US$ per Million Metric British Thermal Unit
  "PNGASUS" = "Nat. Gas Henry Hub", # Natural Gas, Natural Gas spot price at the Henry Hub terminal in Louisiana, US$ per Million Metric British Thermal Unit
  # "PPROPANE" = "Propane", # North American Spot LPG Propane Price/Mont Belvieu LST
  
  # ENERGY TRANSITION INPUT MATERIALS PRICES (SOME I'M NOT SURE ABOUT THEIR RELEVANCE BUT HERE NONETHELESS)
  "NRG_TRANS_METAL_INDEX" = "Nrg. Transition Metals Composite", # Energy Transition Metal Index
  "LITHIUM_BATTERY_GRADE" = "Battery-Grade Lithium", # Lithium Metal =99%, Battery Grade	
  "MANGANESE_ELECTRO_CIF_NWE" = "Manganese", # Manganese Electro CIF NWE (US$/MT)
  "RARE_EARTH_CARB_REO" = "Rare Earth Carbonate", # Rare Earth Carbonate REO 42-45 Dom.	
  "SILICON_LUMPS_CIF" = "Silicon Lumps", # Silicon Lumps CIF NWE (US$/MT)	
  "VANADIUM_PENTO_CIF_NWE" = "Vanad. Pentox.") #Vanadium Pentoxide CIF NWE
  
# Extract the actual data (from row 5 onward)
data <- commodity_prices %>%
  slice(-(1:3)) %>% 
  rename(date = Commodity)

# Transpose descriptions to align with column names
description_long <- descriptions %>% 
  pivot_longer(everything(), names_to = "column", values_to = "value") %>%
  group_by(column) %>%
  mutate(desc_row = paste0("desc_", row_number())) %>%
  pivot_wider(names_from = desc_row, values_from = value)

# Join descriptions back into the data
data_long <- data %>%
  pivot_longer(-date, names_to = "column", values_to = "value") %>%
  left_join(description_long, by = "column") %>% 
  mutate(category = case_when(grepl("COAL", column) ~ "Coal",
                          grepl("GAS", column) ~ "Gas",
                          grepl("OIL", column) ~ "Oil",
                          column %in% c("PALLFNF", "PINDU", "PNRG") ~ "Composite Commodity Indices",
                          column %in% c("NRG_TRANS_METAL_INDEX", "LITHIUM_BATTERY_GRADE", "MANGANESE_ELECTRO_CIF_NWE", "RARE_EARTH_CARB_REO", "SILICON_LUMPS_CIF", "VANADIUM_PENTO_CIF_NWE") ~ "Nrg. Transition Input Material Prices",
                          TRUE ~ NA))

# Optional — tidy format back to wide if needed
final_data <- data_long %>%
  pivot_wider(names_from = column, values_from = value) %>% 
  rename(commodity_type = desc_1,
         type = desc_2,
         frequency = desc_3) %>% 
   separate(date, sep = "M", into = c("year", "month")) %>% 
    mutate(across(!c(commodity_type, type, frequency, category), as.numeric)) %>% 
  mutate(date_utc = ym(paste0(year, month)))
  
plot_data <- final_data %>% 
  pivot_longer(!c(year, month, commodity_type, type, frequency, date_utc, category)) %>% 
  filter(!is.na(value) & name %in% names(rel_vars)) %>% 
  mutate(labs = unname(rel_vars[name])) 

plot_data %>% 
  select(category, labs, commodity_type, type) %>% 
  mutate(commodity_type = gsub("/", " per", commodity_type)) %>% 
  rename('Commodity Type' = category,
         'Index Label (in plots)' = labs, 
         'Index Definition' = commodity_type, 
         'Index Unit (USD or Index)' = type) %>% 
         distinct %>% kable() 

plot_data %>% 
  filter(category != "Nrg. Transition Input Material Prices" & type == "USD") %>% 
  mutate(labs = unname(rel_vars[name])) %>% 
  ggplot(aes(x = date_utc, y = value, color = labs)) + 
  geom_line() + 
  facet_wrap(~category, scales = "free_y") + 
  theme(legend.position = "bottom") +
  labs(title = "Commodity Price (where available in USD)", 
       x = "Date", 
       y = "USD (log)",
       color = "Commodity Price") +
  theme_minimal() +
  scale_color_brewer(palette = "Paired") +
    scale_y_continuous(trans = "log2") +
  theme(legend.position = "bottom", ncol = 2)


plot_data %>% 
  filter(category != "Nrg. Transition Input Material Prices" & type != "USD") %>% 
  ggplot(aes(x = date_utc, y = value, color = labs)) + 
  geom_line() + 
  #facet_wrap(~category, scales = "free_y") + 
  theme(legend.position = "bottom") +
  labs(title = "Commodity Price Indices", 
       x = "Date", 
       y = "Index Value (log)",
       color = "Commodity Price Index") +
  theme_minimal() +
  scale_color_brewer(palette = "Paired") +
    scale_y_continuous(trans = "log2") +
  theme(legend.position = "bottom", ncol = 2)

plot_data %>% 
  filter(category == "Nrg. Transition Input Material Prices") %>% 
  mutate(labs = unname(rel_vars[name])) %>% 
  ggplot(aes(x = date_utc, y = value, color = labs)) + 
  geom_line() + 
  facet_wrap(~type, scales = "free_y") + 
  theme(legend.position = "bottom") +
  labs(title = "Nrg. Transition Metal Indices", 
       x = "Date", 
       y = "Value (Index or USD - log)",
       color = "Commodity Price Index") +
  scale_y_continuous(trans = "log2") +
  theme_minimal() +
  scale_color_viridis_d(option = "plasma")


```

```{r, echo = FALSE, fig.height = 6, fig.width = 10,  warning = FALSE, cache = TRUE}

ng_price <- final_data %>% 
  select(date_utc, PNGASEU, PALLFNF, PINDU) %>% 
  group_by(date_utc) %>% 
  summarise(across(c(PNGASEU, PALLFNF, PINDU), ~ifelse(max(., na.rm = TRUE) == -Inf, NA, max(., na.rm = TRUE))))

p1 <- ng_price %>% 
  ggplot(aes(x = date_utc)) +
  geom_line(aes(y = PNGASEU, color = "Natural Gas, Netherlands TTF Natural Gas Forward Day Ahead, US$ per Million Metric British Thermal Unit")) +
  geom_line(aes(y = PALLFNF, color = "Fuel & Non-Fuel Commodities: All Commodity Price Index, 2016 = 100, includes both Fuel and Non-Fuel Price Indices")) + 
  geom_line(aes(y = PINDU, color = "Indust. Input Price: Industrial Inputs Price Index, 2016 = 100, includes Agricultural Raw Materials and Base Metals Price Indices")) +
  labs(
    title = "level",
    y = "Price Index",
    x = "Date",
    color = "Commodity Index"
  ) + 
  theme_minimal() +
  theme(legend.position = "none")

p2<- ng_price %>% 
  ggplot(aes(x = date_utc)) +
  geom_line(aes(y = PNGASEU, color = "Natural Gas, Netherlands TTF Natural Gas Forward Day Ahead, US$ per Million Metric British Thermal Unit")) +
  geom_line(aes(y = PALLFNF, color = "Fuel & Non-Fuel Commodities: All Commodity Price Index, 2016 = 100, includes both Fuel and Non-Fuel Price Indices")) + 
  geom_line(aes(y = PINDU, color = "Indust. Input Price: Industrial Inputs Price Index, 2016 = 100, includes Agricultural Raw Materials and Base Metals Price Indices")) +
  labs(
    title = "log-level",
    y = "Price Index (log)",
    x = "Date",
    color = "Commodity Index"
  ) + 
  theme_minimal() +
  theme(legend.position = "bottom") +
  scale_y_continuous(trans = "log2") +
  guides(color = guide_legend(ncol = 1))

p1/p2 + plot_annotation(title = "Preliminary Selected Commodity Prices for Model Selection")

```

#### **Net Imports**

Imports and export flows of electricity from [ENTSOE Transparency Platform](https://transparency.entsoe.eu/content/static_content/Static%20content/knowledge%20base/data-views/transmission-domain/Data-view%20Cross%20Border%20Physical%20Flows.html).                    
Physical flows between bidding zones per market time unit.              
Physical flow is defined as the measured real flow of energy between neighbouring bidding zones on the cross borders.               

**Note 1: Net imports still has some missing data and I'm not quite sure where it comes from (see Austria, Denmark, France, Switzerland).**                 
**Note 2: Also, the seeming upper and lower limits must have to do with capacity constraints on imports and exports (see Belgium, Norway, Sweden).**

```{r, echo = FALSE, fig.height = 8, fig.width = 12, warning = FALSE, cache = TRUE}

imp_exp <- readRDS(here("data/raw/ENTSOE/imports_exports_DE/imports_exports_DE.RDS")) %>% 
  rename(date_utc = date) %>% 
  rowwise() %>%
  mutate(total_net_imports = sum(c_across(starts_with("net_imports_")), na.rm = TRUE)) %>%
  ungroup()

imp_exp %>% 
  ggplot(aes(x = date_utc, y = total_net_imports)) + 
  geom_line(color = "grey50") +
  geom_ma(ma_fun = SMA, n = 731, color = "purple") +
  geom_ma(ma_fun = SMA, n = 4383, color = "blue") +
  geom_ma(ma_fun = SMA, n = 8766, color = "yellow")

imp_exp %>%
  select(date_utc, contains("net_imports")) %>%
  filter(date_utc >= "2015-01-01" & date_utc < "2025-01-01") %>%
  pivot_longer(!date_utc) %>%
  ggplot(aes(x =  date_utc, y = value, color = name)) +
  geom_line(color = "grey50") +
  geom_ma(ma_fun = SMA, n = 731, color = "purple") +
  geom_ma(ma_fun = SMA, n = 4383, color = "blue") +
  geom_ma(ma_fun = SMA, n = 8766, color = "yellow") +
  facet_wrap(~name, scales = "free_y")



```

#### **Day-ahead Solar and Wind Forecasts**

A forecast of wind and solar power generation (MW) per country per hour of the following day data from [ENTSOE Transparency Platform](https://transparency.entsoe.eu/content/static_content/Static%20content/knowledge%20base/data-views/generation/Data-view%20Generation%20Forecasts%20-%20Day%20Ahead%20for%20Wind%20and%20Solar.html).                   

**Note: we need to consider the logical link between these forecasts and price-setting/auction behaviour.**

```{r, echo = FALSE, fig.height = 8, fig.width = 12,  warning = FALSE, cache = TRUE}

fcast_sw <- readRDS(here("data/raw/ENTSOE/generation_forecasts_solar_wind/de_forecasts_solar_wind_consolidated.RDS")) %>% 
  rename(date_utc = date)

fcast_sw %>% 
  pivot_longer(!date_utc) %>% 
  ggplot(aes(x = date_utc, y = value, group = name, color = name)) + 
  geom_line(alpha = 0.2) +
  #geom_ma(ma_fun = SMA, n = 731, color = "yellow") +
  geom_ma(ma_fun = SMA, n = 4383) +
  geom_ma(ma_fun = SMA, n = 8766) +
  theme_minimal()#+
  #facet_wrap(~name)

```

#### **Redispatching Costs**
Four transmission system operators (TSOs) in Germany actively monitor the contracted transmission of electricity in the grid to ensure load-balancing "in the event of imminent overloads in the electricity grid."                        

"Redispatch is a request to adjust the active power feed-in of plants (conventional power plants, CHP plants, renewable energy plants, storage facilities) by the grid operator with the aim of avoiding or eliminating any bottlenecks that occur. This measure can be applied within and across control areas. By reducing the active power feed-in of one or more systems while simultaneously increasing the active power feed-in of one or more other systems, the total active power feed-in remains almost unchanged while at the same time relieving a bottleneck" ([NETZTRANSPARENZ.DE](https://www.netztransparenz.de/en/Ancillary-Services/System-operations/Redispatch])).

([NETZTRANSPARENZ.DE](https://www.netztransparenz.de/en/Ancillary-Services/System-operations/Redispatch])) provide data on redispatch measures for the average, maximum, and per-quarter-hour(??) MW reduction. I think the latter is most relevant. See example at the link above.                

The plots below show the associated "redispatching work" by primary energy type (conventional, renewable, miscellaneous, and unspecified).        

**Note: This information is also available from [ENTSO-E](https://transparency.entsoe.eu/congestion-management/r2/redispatching-internal/show). We might consider using this data source instead for consistency.**               
**Note: to summarise by time period, I use either the mean or sum total of the measure of "redispatching work in mwh." I am still not 100% sure what this means and whether this measure is most appropriate (or best summarised per hour as a sum or mean). We MUST revisit this data before implementation - NON-NEGOTIABLE.**

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 8, fig.width = 12, echo = FALSE}

redisp <- readRDS(here("data/raw/netztransparenz_redispatching_costs/prelim_redispatching_costs.RDS"))

p1 <- redisp %>% 
  ggplot(aes(x = date, y = mean_work_mwh, color = primary_energy_type)) + 
  geom_line() +
  facet_wrap(~primary_energy_type) +
  theme_minimal() +
  labs(x = "Date", y = "Redispatching Work (mwh)", title = "Average By Energy Type") +
  theme(legend.position = "none")+
    scale_color_brewer(palette = "Set2", na.value = "grey50")


p2 <- redisp %>% 
  ggplot(aes(x = date, y = total_work_mwh, color = primary_energy_type)) + 
  geom_line() +
  facet_wrap(~primary_energy_type) +
  theme_minimal() +
  labs(x = "Date", y = "Redispatching Work (mwh)", title = "Total Sum By Energy Type") +
  theme(legend.position = "none") +
    scale_color_brewer(palette = "Set2", na.value = "grey50")

p1 + p2

plots <- list()
for(unit in c("day", "week", "month", "year")){
  if(unit == "year"){
    pos = "bottom"
  }else{pos = "none"}
  plots[[unit]] <- redisp %>%
  mutate(day = floor_date(date, unit = unit)) %>% 
  group_by(day, primary_energy_type) %>% 
  summarise(total_work_mwh = sum(total_work_mwh, na.rm = TRUE)) %>% 
  ggplot(aes(x = day, y = total_work_mwh, fill = primary_energy_type)) +
  geom_area(position = "stack") +
  theme_minimal() +
  labs(
    x = "Date",
    y = "Redispatching Work (MWh)",
    title = toupper(unit),
    fill = "Primary Energy Type"
  ) +
    theme(legend.position = pos) +
    scale_fill_brewer(palette = "Set2", na.value = "grey50")
}

grid.arrange(grobs = plots, top = "Total Redispatching Work by Primary Energy Type (Summarised for various intervals)")

redisp_df <- redisp %>% 
  group_by(date) %>% 
  summarise(total_work_mwh = sum(total_work_mwh, na.rm = TRUE)) %>% 
  ungroup %>% 
  rename(date_utc = date,
         redisp_work_mwh = total_work_mwh)

redisp_df %>% 
  ggplot(aes(x = date_utc, y = redisp_work_mwh)) +
  geom_line() +
  theme_minimal() +
  labs(
    x = "Date",
    y = "Redispatching Work (MWh)",
    title = "Redispatching Work (MWh) Total Across All Energy Types"
  )

```

#### **Combining Data**

For transparency's sake, the code is below:             
1. merge price, generation data by date-time and country-code             
2. upper limit of TS to end of 2024             
3. log transform with x + 1 to avoid zero value issues             
4. create "share" values by dividing any generation variable by total load             
5. for monthly commodity price values I fill these variables *forward*             
6. Create hour and month dummies             

**Note: Potential transformation issues to discuss:**          
1. Forward-fill of monthly commodity price values             
2. To deal with 0 values for certain variables I need to log_transform the value + 1. I don't think this is a major issue given the magnitude of these variables but worth reconsidering.             
3. **(!!)** For net imports there are several observations for country-specific flows that are NA. Most result from NA values reported for both imports and exports at those hours. However, for Denmark (1,860 obs) and France (2,234 obs) this issue results from non-NA imports and NA exports. **THIS WILL ABSOLUTELY NEED TO BE REINVESTIGATED - WE CANNOT FORMALISE ANY RESULTS WITHOUT FINDING A WAY TO DEAL WITH THIS.**

```{r, fig.height = 8, fig.width = 12,  warning = FALSE}

de_all <- de_hourly_prices %>% 
  rename(date_utc = datetime_utc) %>% 
  left_join(., entsoe_de, by = c("date_utc", "country")) %>% 
  left_join(., de_generation, by = c("date_utc", "country", "country_code")) %>% 
  arrange(date_utc) %>% 
  select(-starts_with("sum_")) %>% 
  filter(date_utc < "2024-03-31 02:00:00" & !is.na(gen_biomass_mw)) %>% 
  mutate(across(contains("gen"), ~log(. + 1), .names = "log_{.col}"),
         across(starts_with("gen"), ~./load, .names = "shr_{.col}"),
         log_load = log(load+1)) %>% 
  left_join(., imp_exp, by = "date_utc") %>% 
  mutate(across(contains("net_imports"), ~ifelse(is.na(.), 0, .)),
         shr_net_imports = total_net_imports/load) %>% 
  left_join(., fcast_sw, by = "date_utc") %>% 
  left_join(., redisp_df, by = "date_utc")

de_full <- de_all %>% 
  left_join(., ng_price, by = "date_utc") %>% 
  # We fill the monthly values down! 
  fill(PNGASEU, .direction = "down") %>% 
  fill(PALLFNF, .direction = "down") %>% 
  fill(PINDU, .direction = "down") %>% 
  # Given our redispatching data covers the 2015-2024 time period, it is safe to assume that NA values are 0 values. Barring the data/metric choice issues outlined in the "Redispatching Costs" tab above, of course.
  mutate(redisp_work_mwh = ifelse(is.na(redisp_work_mwh), 0, redisp_work_mwh),
         # Create hourly and monthly dummies
        hour = as.factor(hour(datetime_local)),
         month = as.factor(month(datetime_local)),
        log_redisp_mwh = log(redisp_work_mwh + 1),
        log_PNGASEU = log(PNGASEU + 1),
        log_PALLFNF = log(PALLFNF + 1),
        log_PINDU = log(PINDU + 1)) %>% 
  dummy_cols(select_columns = c("hour", "month"), remove_first_dummy = TRUE, remove_selected_columns = TRUE)

```


#### (TBA) Auction Bid Data

#### (TBA) Economic Activity

### **Approaching a model...** {.tabset}
Below, I incorporate most explanatory variables (except solar and wind forecasts) above into models of the mean (not yet variance). The first model tab incorporates the variables simply as (log) levels whereas the second incorporates them as shares of total "load." In each tab, I run the model with the same set of regressors to be selected over but with or without a log.ewma argument. In line with Rintamaki et al, we incorporate moving average terms for half-day, daily, and weekly price volatility (levels?) via log.ewma argument (correct?). I need to think more closely about how that functions together with the hourly and monthly dummies. 

**Note: log.ewma() for half-day, daily, and weekly price volatilities? Correct idea?**               
**Note: Hourly and daily dummies the best way to incorporate "seasonality"? How might this interfere with the ewma terms?**               
**Note: I do not currently incorporate any ARCH terms.**               
**Note: day-ahead versus current prices in all variables? - are we not interested in deviations from forecasts for price-setting?**                 
**Note: Finally, a basic question, but I do not currently have the output variable (hourly wholesale electricity prices) in logs as it frequently takes negative values)**                

```{r, warning = FALSE}
# Check to make sure data is ordered
de_full %>% arrange(date_utc) %>% all.equal(de_full)

```


#### Levels as Exp. Vars.
```{r, cache = TRUE,fig.height = 10, cache = TRUE}

reg_mat <- as.matrix(select(de_full,
                                       'log_load', 
                                       #'log_gen_biomass_mw',
                                       'log_gen_gas_mw', 
                                       'log_gen_coal_mw', 
                                       'log_gen_hydro_mw',
                                       'log_gen_geoth_mw', 
                                       'log_gen_nuclear_mw', 
                                       'log_gen_oth_ren_mw', 
                                       'log_gen_solar_mw', 
                                       'log_gen_wind_mw',
                                       'log_PNGASEU', 
                                       'log_PALLFNF',
                                       'log_PINDU',
                                       contains('hour'), 
                                       contains('month'),
                                       "net_imports_SE",
                                       "net_imports_PL",
                                       "net_imports_CZ",
                                       "net_imports_BE",
                                       "net_imports_CH",
                                       "net_imports_NO",
                                       "net_imports_NL",
                                       "net_imports_LU",
                                       "net_imports_FR",
                                       "net_imports_DK",
                                       "net_imports_AT",
                                       "log_redisp_mwh"
                                       #"total_net_imports" # Excluded as its sum components are each of the net_imports above
                                       )) # 'gen_wind_mw' 'gen_coal_mw', 'gen_hydro_mw',

de_mod_levs <- arx(de_full$price_eur_m_whe, 
              # Question: In theory, the ARCH(24) would proxy the seasonal (daily) AR term?
              #arch = 1:24, 
              mxreg = reg_mat)

de_mod_levs_logewma <- arx(de_full$price_eur_m_whe, 
              # As in Rintamaki et al. the below line incorporates moving average terms for the half-day (12), day (24 hours) and week (168 hours)  - correct?
              log.ewma = c(12, 24, 168),
              # Question: In theory, the ARCH(24) would proxy the seasonal (daily) AR term?
              #arch = 1:24, 
              mxreg = reg_mat)

# model selection and plotting of residuals
de_levs_sel <- getsm(de_mod_levs, ar.LjungB = NULL, arch.LjungB = NULL)
de_levs_sel %>% plot

de_levs_sel_logewma <- getsm(de_mod_levs_logewma, ar.LjungB = NULL, arch.LjungB = NULL)
de_levs_sel_logewma %>% plot

```


#### Shares as Exp. Vars.

```{r, fig.height = 10, warning = FALSE, cache = TRUE}

reg_mat_shares <- as.matrix(select(de_full, 
                                       #'shr_gen_biomass_mw',  
                                       'shr_gen_gas_mw', 
                                       'shr_gen_coal_mw',
                                       'shr_gen_hydro_mw',
                                       'shr_gen_geoth_mw', 
                                       'shr_gen_nuclear_mw', 
                                       'shr_gen_oth_ren_mw',
                                       'shr_gen_solar_mw',
                                       'shr_gen_wind_mw',
                                       'log_PNGASEU',
                                       'log_PALLFNF',
                                       'log_PINDU',
                                       contains('hour'), 
                                       contains('month'),
                                       "log_redisp_mwh",
                                       shr_net_imports)) # 'gen_wind_mw' 'gen_coal_mw', 'gen_hydro_mw',

de_mod_shares <- arx(de_full$price_eur_m_whe, 
              mxreg = reg_mat_shares) 

de_mod_shares_logewma <- arx(de_full$price_eur_m_whe, 
                     log.ewma = c(12, 24, 168),
                     mxreg = reg_mat_shares) 

de_shares_sel <- getsm(de_mod_shares, ar.LjungB = NULL, arch.LjungB = NULL)
de_shares_sel %>% plot
de_shares_sel_logewma <- getsm(de_mod_shares_logewma, ar.LjungB = NULL, arch.LjungB = NULL)
de_shares_sel_logewma %>% plot

# # Perform gets model selection over the log-variance model above
# de_vmod <- getsv(de_mod, t.pval = 0.001, ar.LjungB = NULL)
# 
# de_vmod %>% plot
# 
# data_de %>% filter(de_price < 0)

```












## (TBA) Spotlight on UK, Germany, Denmark

Here, see the time series for Germany and Denmark (to compare to the data avialable in Rintamaki et al. - color portion of the TS plots). UK spotlight to discuss potential interest to David. 

```{r, echo = FALSE, eval = FALSE, fig.height = 10, warning = FALSE}


### ENTSOE Data
entsoe <- readRDS(here("data/out/entsoe_load_data_consolidated.rds")) %>% 
  # MATCH on DE and DK (DK_W exists but only for earlier time period - until end of 2009)
  tibble

# Loads hourly price data for de, dk1, dk2
for(cty in c('dk1', 'dk2', 'de')){
  temp_entsoe <- entsoe %>% 
    filter(country_code == toupper(gsub("\\d", "", cty))) %>% 
    # THIS NEEDS TO BE CORRECTED - FOR NOW CERTAIN TIME PERIODS HAVE MULTIPLE OBSERVATIONS WITH DIFFERENT COVERAGE RATIOS - FIX IN CLEANING_ENTSOE_LOAD.R
    group_by(date_utc) %>%
    slice_max(cov_ratio, n = 1) %>%
    ungroup() %>% 
    # Certain 2 am recordings in various days in March of 2010-2014 are NA...fill these values for now but should be investigated
    fill(load, .direction = c("down"))
           
  temp <- read_xlsx(here('code/rintamaki_replication/data/raw_data.xlsx'), sheet = cty) %>% 
    clean_names %>% 
    mutate(date = ymd_h(paste(date, hour))) %>% 
    left_join(., temp_entsoe, by = join_by(date == date_utc)) 
  
  assign(paste0("data_", cty), temp)
}

eu_hourly <- read.csv(here('data/raw/EMBER_europe_wholesale_data/all_countries.csv')) %>% 
  tibble %>% 
  clean_names %>% 
  mutate(across(contains("datetime"), ~ymd_hms(.x))) 
# Germany
p_uk <- eu_hourly %>% 
  filter(country == "United Kingdom") %>% 
  ggplot() +
  geom_line(aes(x = datetime_local, y = price_eur_m_whe), linewidth = 0.1) +
  labs(title = "UK: Hourly Electricity Prices", y = "Hourly Electricity Price (EUR/MWH)", x = "Date")

# Germany
p_de <- data_de %>% 
  ggplot(aes(x = date, y = de_price)) +
  geom_line(linewidth = 0.1, color = "purple") +
  geom_line(data = filter(eu_hourly, country == "Germany"), aes(x = datetime_local, y = price_eur_m_whe), linewidth = 0.1) +
  labs(title = "Germany: Hourly Electricity Prices", y = "Hourly Electricity Price (EUR/MWH)", x = "Date")

# DK1
p_dk1 <- ggplot() +
  geom_line(data = data_dk1, aes(x = date, y = dk1_price), linewidth = 0.1, color = "darkgreen") +
  geom_line(data = filter(eu_hourly, country == "Denmark"), aes(x = datetime_local, y = price_eur_m_whe)) +
  labs(title = "Denmark: Hourly Electricity Prices", subtitle = "Using DK1 prices from Rintamaki et al.", y = "Hourly Electricity Price (EUR/MWH)", x = "Date")

# DK2
p_dk2 <- data_dk2 %>% 
  ggplot(aes(x = date, y = dk2_price)) +
  geom_line(linewidth = 0.1, color = "coral") +
  geom_line(data = filter(eu_hourly, country == "Denmark"), aes(x = datetime_local, y = price_eur_m_whe)) +
  labs(title = "Denmark: Hourly Electricity Prices", subtitle = "Using DK2 prices from Rintamaki et al.", y = "Hourly Electricity Price (EUR/MWH)", x = "Date")


((p_uk + p_de) / (p_dk1 + p_dk2)) + plot_annotation(
  title = 'Hourly Wholesale Electricity Price Data UK, Germany, and Denmark',
  subtitle = 'Black represents EMBER data, colorful data represents data from Rintamaki replication.',
)

```

### Daily and Monthly Prices
```{r, echo = FALSE, fig.height = 10, warning = FALSE}

eu_daily <- read.csv(here('data/raw/EMBER_europe_wholesale_data/european_wholesale_electricity_price_data_daily.csv')) %>% 
  tibble %>% 
  clean_names %>% 
  mutate(date = ymd(date))


eu_monthly <- read.csv(here('data/raw/EMBER_europe_wholesale_data/european_wholesale_electricity_price_data_monthly.csv')) %>% 
  tibble %>% 
  clean_names %>% 
  mutate(date = ymd(date))

ggplot() +
  geom_line(data = eu_daily, aes(x = date, y = price_eur_m_whe)) +
  geom_line(data = eu_monthly, aes(x = date, y = price_eur_m_whe), color = "steelblue") +
  facet_wrap(~country) +
  labs(title = "Daily and Monthly Wholesale Electricity Prices", subtitle = "Black (blue) represents daily (monthly) prices.", y = "Price (EUR/MWH)", x = "Date") +
  theme_minimal()

ggplot() +
  geom_line(data = eu_daily, aes(x = date, y = price_eur_m_whe)) +
  geom_line(data = eu_monthly, aes(x = date, y = price_eur_m_whe), color = "steelblue") +
  scale_y_continuous(trans='log2') +
  facet_wrap(~country) +
  labs(title = "Daily and Monthly Wholesale Electricity Prices", subtitle = "Black (blue) represents daily (monthly) prices.", y = "Price (EUR/MWH)", x = "Date") +
  theme_minimal()

```

## (TBA) Full Extension to Europe

Using data from [EMBER](https://ember-energy.org/data/european-wholesale-electricity-price-data/) on European wholesale electricity prices (hourly - daily and monthly also exist), I perform the same analysis as above. The hourly prices are the day-ahead wholesale prices by country.

```{r, echo = FALSE, fig.height = 14, warning = FALSE, cache = TRUE}
library(countrycode)

eu_hourly <- read.csv(here('data/raw/EMBER_europe_wholesale_data/all_countries.csv')) %>% 
  tibble %>% 
  clean_names %>% 
  mutate(across(contains("datetime"), ~ymd_hms(.x)))

eu_hourly %>% 
  ggplot(aes(x = datetime_local, y = price_eur_m_whe)) +
  geom_line() +
  facet_wrap(~country, ncol = 4, scales = "free") +
  labs(title = "Hourly Wholesale Electricity Prices", subtitle = "Prices are average day-ahead spot prices per MWh sold per time period", x = "Date", y = "Euro/MWh") +
  theme_minimal()

sample <- eu_hourly %>% 
  select(country) %>% 
  unique

```

The following is data from [ENTSO-E](https://www.entsoe.eu/data/power-stats/) on hourly electricity loads. 

```{r, echo = FALSE, fig.height = 14, warning = FALSE, cache = TRUE}

### ENTSOE Data
entsoe <- readRDS(here("data/out/entsoe_load_data_consolidated.rds")) %>% 
  tibble %>% 
  # Filters old observations from 2006-07 for CS - Serbia and Montenegro - represented by "RS" and "ME", respectively
  filter(!(country_code %in% c("CS"))) %>% 
  # Denmark is inconsistently names - DK_W until 2010 and DK after 2010 - no observation for Denmark East exists therefore consolidation seems OK
  mutate(country_code = ifelse(country_code == "DK_W", "DK", country_code),
         # adds new column with country names
         country = countrycode(country_code, "iso2c", "country.name"),
         country = ifelse(is.na(country), paste0("?",country_code, "?"), country)) %>% 
  # restrict to country's for which we have hourly price data
  filter(country %in% unique(eu_hourly$country)) 

all.equal(sort(unique(entsoe$country)), sort(unique(eu_hourly$country)))

entsoe %>% 
  filter(date_utc >= "2010-01-01 00:00:00") %>% 
  ggplot(aes(x = date_utc, y = load)) +
  geom_line() +
  facet_wrap(~country, ncol = 4, scales = "free_y") + 
  labs(title = "Hourly Electricity Load", subtitle = "Date from ENTSO-E", x = "Date", y = "UNIT?") +
  theme_minimal()
  
```


